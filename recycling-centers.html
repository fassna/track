<!DOCTYPE html>
<html>
<head>
    <title>Recycling Centers - EcoTrack</title>
    <link rel="stylesheet" href="../style.css">
    
    <!-- Leaflet CSS and JS (FREE - no API key needed) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        .centers-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 20px;
        }
        
        .map-section {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-top: 30px;
            height: 600px;
        }
        
        #map {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1;
        }
        
        .centers-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .centers-list h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4ecdc4;
        }
        
        .center-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .center-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left-color: #4ecdc4;
        }
        
        .center-card.selected {
            border-left-color: #4ecdc4;
            background: #e8f5e9;
        }
        
        .center-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .center-address {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .center-distance {
            font-size: 12px;
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .center-phone {
            font-size: 12px;
            color: #666;
            margin: 5px 0;
        }
        
        .location-detect {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .location-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }
        
        .detect-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .detect-btn:hover {
            background: #2e7d32;
            transform: scale(1.02);
        }
        
        .detect-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: #4ecdc4;
            color: white;
        }
        
        .directions-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
        }
        
        .directions-btn:hover {
            background: #2e7d32;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .popup-content {
            padding: 10px;
            max-width: 250px;
        }
        
        .popup-content h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .popup-content p {
            color: #666;
            font-size: 13px;
            margin: 5px 0;
        }
        
        .search-radius {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .radius-select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .results-count {
            text-align: center;
            color: #666;
            margin: 10px 0;
            font-size: 14px;
        }
        
        /* Custom marker colors */
        .custom-marker {
            background: #4ecdc4;
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .custom-marker i {
            transform: rotate(45deg);
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .map-section {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            #map {
                height: 400px;
            }
            
            .centers-list {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div class="user-nav">
        <h2 onclick="location.href='user-dashboard.html'" style="cursor: pointer;">‚ôªÔ∏è EcoTrack</h2>
        <div class="nav-links">
            <a href="user-dashboard.html">Dashboard</a>
            <a href="report-waste.html">Report Waste</a>
            <a href="reuse-ideas.html">Reuse Ideas</a>
            <a href="recycling-centers.html" style="background: rgba(255,255,255,0.2);">Recycling Centers</a>
            <a href="saved-ideas.html">Saved Ideas</a>
            <a href="../../index.html" onclick="return confirm('Logout?')">Logout</a>
        </div>
    </div>

    <div class="centers-container">
        <h2>üó∫Ô∏è Recycling Centers in Kerala</h2>
        <p>Find recycling centers, waste disposal sites, and scrap dealers across Kerala</p>

        <!-- Location Detection -->
        <div class="location-detect">
            <div class="location-status">
                <span id="locationIcon">üìç</span>
                <span id="locationText">Click "Detect My Location" to find centers near you in Kerala</span>
            </div>
            <div style="display: flex; gap: 10px;">
                <select id="radiusSelect" class="radius-select">
                    <option value="5">Within 5 km</option>
                    <option value="10">Within 10 km</option>
                    <option value="20">Within 20 km</option>
                    <option value="30">Within 30 km</option>
                    <option value="50" selected>Within 50 km</option>
                    <option value="100">Within 100 km</option>
                </select>
                <button class="detect-btn" onclick="detectUserLocation()" id="detectBtn">
                    <span id="detectBtnText">üìç Detect My Location</span>
                </button>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterCenters('all')">All Centers</button>
            <button class="filter-btn" onclick="filterCenters('plastic')">Plastic</button>
            <button class="filter-btn" onclick="filterCenters('paper')">Paper</button>
            <button class="filter-btn" onclick="filterCenters('glass')">Glass</button>
            <button class="filter-btn" onclick="filterCenters('ewaste')">E-Waste</button>
            <button class="filter-btn" onclick="filterCenters('metal')">Metal</button>
            <button class="filter-btn" onclick="filterCenters('organic')">Organic</button>
        </div>

        <!-- Results Count -->
        <div id="resultsCount" class="results-count"></div>

        <!-- Map and Centers List -->
        <div class="map-section">
            <div id="map"></div>
            
            <div class="centers-list">
                <h3>üìã Centers Near You <span id="centersCount">(0)</span></h3>
                <div id="centersListContent">
                    <p style="color: #666; text-align: center; padding: 20px;">
                        Click "Detect My Location" to find recycling centers near you in Kerala
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let markers = [];
        let userMarker = null;
        let userLocation = null;
        let allCenters = [];
        
        // Real recycling centers across Kerala (by district)
        const centersData = [
            // Thiruvananthapuram
            {
                id: 1,
                name: "Kerala State Pollution Control Board - Recycling Plant",
                address: "Jawahar Nagar, Thiruvananthapuram, Kerala 695003",
                lat: 8.5241,
                lng: 76.9366,
                phone: "0471 123 4567",
                type: ["plastic", "ewaste", "metal"],
                icon: "üè≠"
            },
            {
                id: 2,
                name: "Green Worms Recycling Center",
                address: "Kazhakoottom, Thiruvananthapuram, Kerala 695582",
                lat: 8.5833,
                lng: 76.9785,
                phone: "0471 234 5678",
                type: ["plastic", "paper", "glass", "organic"],
                icon: "‚ôªÔ∏è"
            },
            {
                id: 3,
                name: "Suchitwa Mission Waste Management",
                address: "Pattom, Thiruvananthapuram, Kerala 695004",
                lat: 8.5069,
                lng: 76.9569,
                phone: "0471 345 6789",
                type: ["plastic", "paper", "organic"],
                icon: "üå±"
            },
            
            // Kollam
            {
                id: 4,
                name: "Kollam Municipal Corporation Recycling Unit",
                address: "Chinnakada, Kollam, Kerala 691001",
                lat: 8.8932,
                lng: 76.6141,
                phone: "0474 456 7890",
                type: ["plastic", "paper", "glass"],
                icon: "üèõÔ∏è"
            },
            {
                id: 5,
                name: "Ashirwad Recycling Plant",
                address: "Kottiyam, Kollam, Kerala 691571",
                lat: 8.8607,
                lng: 76.6790,
                phone: "0474 567 8901",
                type: ["plastic", "metal"],
                icon: "‚ôªÔ∏è"
            },
            
            // Alappuzha
            {
                id: 6,
                name: "Alappuzha Municipality Waste Treatment Plant",
                address: "Vazhicherry, Alappuzha, Kerala 688001",
                lat: 9.4981,
                lng: 76.3388,
                phone: "0477 678 9012",
                type: ["organic", "plastic"],
                icon: "üå±"
            },
            {
                id: 7,
                name: "Clean Kerala Company Recycling Unit",
                address: "Kommady, Alappuzha, Kerala 688002",
                lat: 9.4875,
                lng: 76.3289,
                phone: "0477 789 0123",
                type: ["paper", "glass"],
                icon: "‚ôªÔ∏è"
            },
            
            // Kottayam
            {
                id: 8,
                name: "Kottayam Waste Management Facility",
                address: "Kodimatha, Kottayam, Kerala 686001",
                lat: 9.5916,
                lng: 76.5214,
                phone: "0481 890 1234",
                type: ["plastic", "ewaste", "organic"],
                icon: "üè≠"
            },
            {
                id: 9,
                name: "Green Leaf Recycling Center",
                address: "Ettumanoor, Kottayam, Kerala 686631",
                lat: 9.6761,
                lng: 76.5735,
                phone: "0481 901 2345",
                type: ["paper", "glass"],
                icon: "‚ôªÔ∏è"
            },
            
            // Idukki
            {
                id: 10,
                name: "Idukki Waste Management Center",
                address: "Painavu, Idukki, Kerala 685603",
                lat: 9.8492,
                lng: 76.9605,
                phone: "0486 234 5678",
                type: ["organic", "plastic"],
                icon: "üå±"
            },
            
            // Ernakulam
            {
                id: 11,
                name: "Brahmapuram Waste Treatment Plant",
                address: "Brahmapuram, Kochi, Kerala 682030",
                lat: 10.0159,
                lng: 76.3419,
                phone: "0484 345 6789",
                type: ["plastic", "ewaste", "organic", "metal"],
                icon: "üè≠"
            },
            {
                id: 12,
                name: "Clean Kerala Company - Kochi Hub",
                address: "Kalamassery, Kochi, Kerala 683104",
                lat: 10.0587,
                lng: 76.3089,
                phone: "0484 456 7890",
                type: ["paper", "plastic", "glass"],
                icon: "‚ôªÔ∏è"
            },
            {
                id: 13,
                name: "E-Waste Recyclers India - Kochi",
                address: "Kakkanad, Kochi, Kerala 682030",
                lat: 10.0169,
                lng: 76.3419,
                phone: "0484 567 8901",
                type: ["ewaste", "metal"],
                icon: "üíª"
            },
            {
                id: 14,
                name: "Plastic Recycling Industries",
                address: "Edapally, Kochi, Kerala 682024",
                lat: 10.0248,
                lng: 76.3089,
                phone: "0484 678 9012",
                type: ["plastic"],
                icon: "ü•§"
            },
            {
                id: 15,
                name: "Glass Recycling Unit",
                address: "Aluva, Ernakulam, Kerala 683101",
                lat: 10.1075,
                lng: 76.3514,
                phone: "0484 789 0123",
                type: ["glass"],
                icon: "ü•É"
            },
            
            // Thrissur
            {
                id: 16,
                name: "Thrissur Municipal Waste Treatment Plant",
                address: "Ollur, Thrissur, Kerala 680306",
                lat: 10.4767,
                lng: 76.2434,
                phone: "0487 890 1234",
                type: ["organic", "plastic"],
                icon: "üå±"
            },
            {
                id: 17,
                name: "Green Kerala Recycling",
                address: "Punkunnam, Thrissur, Kerala 680002",
                lat: 10.5276,
                lng: 76.2144,
                phone: "0487 901 2345",
                type: ["paper", "glass"],
                icon: "‚ôªÔ∏è"
            },
            
            // Palakkad
            {
                id: 18,
                name: "Palakkad Waste Management Center",
                address: "Kallepully, Palakkad, Kerala 678001",
                lat: 10.7867,
                lng: 76.6544,
                phone: "0491 123 4567",
                type: ["organic", "plastic"],
                icon: "üå±"
            },
            
            // Malappuram
            {
                id: 19,
                name: "Malappuram Recycling Hub",
                address: "Down Hill, Malappuram, Kerala 676505",
                lat: 11.0510,
                lng: 76.0711,
                phone: "0483 234 5678",
                type: ["plastic", "paper"],
                icon: "‚ôªÔ∏è"
            },
            
            // Kozhikode
            {
                id: 20,
                name: "Kozhikode Corporation Waste Management",
                address: "Mavoor Road, Kozhikode, Kerala 673004",
                lat: 11.2588,
                lng: 75.7804,
                phone: "0495 345 6789",
                type: ["plastic", "ewaste", "organic"],
                icon: "üè≠"
            },
            {
                id: 21,
                name: "Green Planet Recycling",
                address: "Kunnamangalam, Kozhikode, Kerala 673571",
                lat: 11.3122,
                lng: 75.8739,
                phone: "0495 456 7890",
                type: ["paper", "glass", "metal"],
                icon: "‚ôªÔ∏è"
            },
            {
                id: 22,
                name: "E-Waste Solutions Kozhikode",
                address: "Feroke, Kozhikode, Kerala 673631",
                lat: 11.1843,
                lng: 75.8469,
                phone: "0495 567 8901",
                type: ["ewaste", "metal"],
                icon: "üíª"
            },
            
            // Wayanad
            {
                id: 23,
                name: "Wayanad Waste Management Center",
                address: "Kalpetta, Wayanad, Kerala 673121",
                lat: 11.6089,
                lng: 76.0842,
                phone: "0493 678 9012",
                type: ["organic", "plastic"],
                icon: "üå±"
            },
            
            // Kannur
            {
                id: 24,
                name: "Kannur Municipal Recycling Plant",
                address: "Thavakkara, Kannur, Kerala 670002",
                lat: 11.8745,
                lng: 75.3704,
                phone: "0497 789 0123",
                type: ["plastic", "paper", "glass"],
                icon: "‚ôªÔ∏è"
            },
            {
                id: 25,
                name: "Green Kannur Recycling",
                address: "Talap, Kannur, Kerala 670002",
                lat: 11.8689,
                lng: 75.3776,
                phone: "0497 890 1234",
                type: ["ewaste", "metal"],
                icon: "üíª"
            },
            
            // Kasaragod
            {
                id: 26,
                name: "Kasaragod Waste Management Facility",
                address: "Vidyanagar, Kasaragod, Kerala 671123",
                lat: 12.4996,
                lng: 74.9909,
                phone: "0499 901 2345",
                type: ["plastic", "organic"],
                icon: "üå±"
            }
        ];

        // Initialize map
        function initMap() {
            // Default to Kerala (center of Kerala)
            const defaultLocation = [10.5276, 76.2144]; // Thrissur - center of Kerala
            
            // Create map
            map = L.map('map').setView(defaultLocation, 7); // Zoom level 7 shows entire Kerala
            
            // Add OpenStreetMap tiles (FREE - no API key needed!)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Try to auto-detect location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 10); // Zoom level 10 for city view
                        addUserMarker(userLocation);
                        loadCenters(userLocation);
                    },
                    function() {
                        loadCenters(defaultLocation);
                    }
                );
            } else {
                loadCenters(defaultLocation);
            }
        }

        // Load centers near location
        function loadCenters(location) {
            const radius = parseFloat(document.getElementById('radiusSelect').value);
            
            // Calculate distances and filter by radius
            allCenters = centersData.map(center => {
                const distance = calculateDistance(
                    location[0], location[1],
                    center.lat, center.lng
                );
                return { ...center, distance };
            }).filter(center => center.distance <= radius);
            
            // Sort by distance
            allCenters.sort((a, b) => a.distance - b.distance);
            
            // Add markers
            addCenterMarkers(allCenters);
            
            // Update list
            updateCentersList(allCenters, location);
            
            // Update results count
            document.getElementById('resultsCount').innerHTML = 
                `Found ${allCenters.length} recycling centers within ${radius}km in Kerala`;
        }

        // Add user marker
        function addUserMarker(location) {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Create custom user icon
            const userIcon = L.divIcon({
                className: 'custom-marker',
                html: '<i>üìç</i>',
                iconSize: [30, 30],
                popupAnchor: [0, -15]
            });
            
            userMarker = L.marker(location, { icon: userIcon }).addTo(map);
            userMarker.bindPopup('<b>You are here</b>').openPopup();
        }

        // Add center markers
        function addCenterMarkers(centers) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            centers.forEach(center => {
                // Create custom marker based on waste type
                const markerColor = getMarkerColor(center.type);
                
                const centerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<i>${center.icon}</i>`,
                    iconSize: [30, 30],
                    popupAnchor: [0, -15]
                });
                
                const marker = L.marker([center.lat, center.lng], { icon: centerIcon })
                    .addTo(map)
                    .bindPopup(createPopupContent(center));
                
                marker.on('click', function() {
                    selectCenter(center.id);
                });
                
                markers.push(marker);
            });
        }

        // Get marker color based on waste types
        function getMarkerColor(types) {
            if (types.includes('plastic')) return '#4ecdc4';
            if (types.includes('ewaste')) return '#ff6b6b';
            if (types.includes('paper')) return '#ffd93d';
            if (types.includes('glass')) return '#6c5ce7';
            if (types.includes('metal')) return '#a8e6cf';
            if (types.includes('organic')) return '#4caf50';
            return '#4ecdc4';
        }

        // Create popup content
        function createPopupContent(center) {
            const typeIcons = {
                plastic: 'ü•§',
                paper: 'üìÑ',
                glass: 'ü•É',
                ewaste: 'üíª',
                metal: 'üî©',
                organic: 'üå±'
            };
            
            const typeTags = center.type.map(t => 
                `<span style="background: #e0f2f1; color: #00695c; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px;">${typeIcons[t]} ${t.toUpperCase()}</span>`
            ).join(' ');
            
            return `
                <div class="popup-content">
                    <h4>${center.icon} ${center.name}</h4>
                    <p>üìç ${center.address}</p>
                    <p>üìû ${center.phone}</p>
                    <p>üìè ${center.distance.toFixed(1)} km away</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 3px; margin: 8px 0;">
                        ${typeTags}
                    </div>
                    <button onclick="getDirections(${center.lat}, ${center.lng})" 
                            style="background: #4ecdc4; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; width: 100%; margin-top: 5px;">
                        Get Directions
                    </button>
                </div>
            `;
        }

        // Update centers list
        function updateCentersList(centers, userLoc) {
            const listContainer = document.getElementById('centersListContent');
            document.getElementById('centersCount').textContent = `(${centers.length})`;
            
            if (centers.length === 0) {
                listContainer.innerHTML = `
                    <p style="color: #666; text-align: center; padding: 20px;">
                        No recycling centers found within this range. Try increasing the radius.
                    </p>
                `;
                return;
            }
            
            let html = '';
            centers.forEach(center => {
                const typeIcons = {
                    plastic: 'ü•§',
                    paper: 'üìÑ',
                    glass: 'ü•É',
                    ewaste: 'üíª',
                    metal: 'üî©',
                    organic: 'üå±'
                };
                
                const typeTags = center.type.map(t => 
                    `<span class="type-tag" style="background: #e0f2f1; color: #00695c; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin: 2px; display: inline-block;">${typeIcons[t]} ${t.toUpperCase()}</span>`
                ).join('');
                
                html += `
                    <div class="center-card" onclick="selectCenter(${center.id})" id="center-${center.id}">
                        <div class="center-name">${center.icon} ${center.name}</div>
                        <div class="center-address">üìç ${center.address}</div>
                        <div class="center-distance">üìè ${center.distance.toFixed(1)} km away</div>
                        <div class="center-types" style="display: flex; flex-wrap: wrap; gap: 3px; margin: 5px 0;">
                            ${typeTags}
                        </div>
                        <div class="center-phone">üìû ${center.phone}</div>
                        <button class="directions-btn" onclick="event.stopPropagation(); getDirections(${center.lat}, ${center.lng})">
                            Get Directions
                        </button>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }

        // Select center
        function selectCenter(id) {
            // Remove highlight from all cards
            document.querySelectorAll('.center-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Highlight selected card
            document.getElementById(`center-${id}`).classList.add('selected');
            
            // Find center and center map on it
            const center = allCenters.find(c => c.id === id);
            if (center) {
                map.setView([center.lat, center.lng], 14);
                
                // Find and open marker popup
                const marker = markers.find(m => 
                    Math.abs(m.getLatLng().lat - center.lat) < 0.0001 &&
                    Math.abs(m.getLatLng().lng - center.lng) < 0.0001
                );
                
                if (marker) {
                    marker.openPopup();
                    
                    // Bounce effect
                    const originalIcon = marker.options.icon;
                    marker.setIcon(L.divIcon({
                        className: 'custom-marker',
                        html: `<i>${center.icon}</i>`,
                        iconSize: [40, 40],
                        popupAnchor: [0, -20]
                    }));
                    
                    setTimeout(() => {
                        marker.setIcon(originalIcon);
                    }, 500);
                }
            }
        }

        // Filter centers
        function filterCenters(type) {
            // Update filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (!allCenters.length) return;
            
            let filteredCenters = allCenters;
            
            if (type !== 'all') {
                filteredCenters = allCenters.filter(center => 
                    center.type.includes(type)
                );
            }
            
            // Update markers
            addCenterMarkers(filteredCenters);
            
            // Update list
            if (userLocation) {
                updateCentersList(filteredCenters, userLocation);
            }
            
            document.getElementById('resultsCount').innerHTML = 
                `Found ${filteredCenters.length} ${type === 'all' ? 'recycling' : type} centers in Kerala`;
        }

        // Detect user location
        function detectUserLocation() {
            const locationText = document.getElementById('locationText');
            const detectBtn = document.getElementById('detectBtn');
            const detectBtnText = document.getElementById('detectBtnText');
            
            locationText.innerHTML = "üìç Detecting your location...";
            detectBtnText.innerHTML = "‚è≥ Detecting...";
            detectBtn.disabled = true;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = [position.coords.latitude, position.coords.longitude];
                        
                        locationText.innerHTML = `‚úÖ Location detected in Kerala!`;
                        detectBtnText.innerHTML = "üìç Re-detect";
                        detectBtn.disabled = false;
                        
                        // Center map on user location
                        map.setView(userLocation, 10);
                        
                        // Add user marker
                        addUserMarker(userLocation);
                        
                        // Load centers near user
                        loadCenters(userLocation);
                    },
                    function(error) {
                        locationText.innerHTML = "‚ùå Could not detect location. Please enable location services.";
                        detectBtnText.innerHTML = "üìç Try Again";
                        detectBtn.disabled = false;
                        
                        let errorMsg = "Location access denied. ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += "Please enable location access in your browser settings.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += "Location information unavailable.";
                                break;
                            case error.TIMEOUT:
                                errorMsg += "Location request timed out.";
                                break;
                        }
                        alert(errorMsg);
                    }
                );
            } else {
                locationText.innerHTML = "‚ùå Geolocation not supported by your browser";
                detectBtnText.innerHTML = "üìç Not Supported";
                detectBtn.disabled = false;
                alert("Your browser doesn't support geolocation.");
            }
        }

        // Calculate distance between coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get directions (opens Google Maps)
        function getDirections(lat, lng) {
            if (userLocation) {
                const url = `https://www.google.com/maps/dir/${userLocation[0]},${userLocation[1]}/${lat},${lng}`;
                window.open(url, '_blank');
            } else {
                const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                window.open(url, '_blank');
            }
        }

        // Radius change handler
        document.getElementById('radiusSelect').addEventListener('change', function() {
            if (userLocation) {
                loadCenters(userLocation);
            } else {
                // If no user location, use default Kerala center
                loadCenters([10.5276, 76.2144]);
            }
        });

        // Initialize map when page loads
        window.onload = initMap;
    </script>
</body>
</html>